<div class="ordering-page">
  <h1>Passer une commande</h1>
  
  <% if flash[:alert] %>
    <div class="alert alert-danger">
      <%= flash[:alert] %>
    </div>
  <% end %>
  
  <!-- Menu des plats -->
  <div class="menu-section">
    <% @categories.each do |category| %>
      <div class="category-section">
        <h2><%= category.name %></h2>
        <% if category.description.present? %>
          <p class="category-description"><%= category.description %></p>
        <% end %>
        <div class="plats-grid">
          <% category.plats.available.each do |plat| %>
            <div class="plat-card">
              <% if plat.image_url.present? %>
                <img src="<%= plat.image_url %>" alt="<%= plat.nom %>" class="plat-image">
              <% end %>
              <div class="plat-info">
                <h3><%= plat.nom %></h3>
                <p class="plat-description"><%= plat.description %></p>
                <p class="price"><%= plat.formatted_price %></p>
                <p class="stock">Stock disponible: <%= plat.stock_quantity %></p>
                
                <%= form_with url: add_to_cart_commandes_path, method: :post, local: false, class: "add-to-cart-form" do |f| %>
                  <%= f.hidden_field :plat_id, value: plat.id %>
                  <div class="quantity-controls">
                    <%= f.number_field :quantity, value: 1, min: 1, max: plat.stock_quantity, class: "quantity-input" %>
                    <%= f.submit "Ajouter au panier", class: "btn btn-primary", disabled: !plat.available? %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Panier -->
  <div class="cart-section">
    <%= render 'cart_items' %>
  </div>
</div>

<style>
.ordering-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.menu-section {
  margin-bottom: 40px;
}

.category-section {
  margin-bottom: 30px;
}

.category-section h2 {
  color: #d4572a;
  border-bottom: 2px solid #d4572a;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.category-description {
  color: #666;
  font-style: italic;
  margin-bottom: 20px;
}

.plats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.plat-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}

.plat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.plat-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.plat-info {
  padding: 15px;
}

.plat-info h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.plat-description {
  color: #666;
  font-size: 14px;
  margin-bottom: 10px;
}

.price {
  font-size: 18px;
  font-weight: bold;
  color: #d4572a;
  margin-bottom: 5px;
}

.stock {
  font-size: 12px;
  color: #888;
  margin-bottom: 15px;
}

.quantity-controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

.quantity-input {
  width: 60px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.cart-section {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-top: 30px;
}

.cart-section h2 {
  color: #333;
  margin-bottom: 20px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: white;
  border-radius: 4px;
  margin-bottom: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.item-info {
  display: flex;
  gap: 15px;
  align-items: center;
}

.item-name {
  font-weight: 500;
}

.item-quantity {
  color: #666;
  font-size: 14px;
}

.item-actions {
  display: flex;
  gap: 15px;
  align-items: center;
}

.item-price {
  font-weight: bold;
  color: #d4572a;
}

.cart-total {
  text-align: right;
  font-size: 20px;
  color: #333;
  padding: 20px 0;
  border-top: 2px solid #d4572a;
  margin: 20px 0;
}

.order-form {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
}

.order-form h3 {
  color: #333;
  margin-bottom: 20px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}

.form-control {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.form-control:focus {
  outline: none;
  border-color: #d4572a;
  box-shadow: 0 0 0 2px rgba(212, 87, 42, 0.2);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  text-decoration: none;
  display: inline-block;
  text-align: center;
  transition: background-color 0.2s;
}

.btn-primary {
  background-color: #d4572a;
  color: white;
}

.btn-primary:hover {
  background-color: #b8481f;
}

.btn-success {
  background-color: #28a745;
  color: white;
}

.btn-success:hover {
  background-color: #218838;
}

.btn-danger {
  background-color: #dc3545;
  color: white;
}

.btn-danger:hover {
  background-color: #c82333;
}

.btn-lg {
  padding: 15px 30px;
  font-size: 16px;
}

.btn-sm {
  padding: 5px 10px;
  font-size: 12px;
}

.empty-cart {
  text-align: center;
  padding: 40px;
  color: #666;
}

.alert {
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}

.alert-danger {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.alert-success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

@media (max-width: 768px) {
  .plats-grid {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .item-actions {
    width: 100%;
    justify-content: space-between;
  }
}
</style>

<script>
document.addEventListener('turbo:load', function() {
  const forms = document.querySelectorAll('.add-to-cart-form');
  
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const submitBtn = this.querySelector('[type="submit"]');
      const originalText = submitBtn.textContent;
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ajout...';
      
      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateCartDisplayWithHTML(data);
          showMessage(data.message, 'success');
        } else {
          showMessage(data.message, 'error');
        }
      })
      .catch(error => {
        showMessage('Erreur lors de l\'ajout au panier', 'error');
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
    });
  });
  
  function updateCartDisplayWithHTML(data) {
    // Mettre à jour le compteur dans la navbar
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
      cartCount.textContent = data.cart_count;
      // Afficher/masquer l'indicateur selon le nombre d'articles
      const cartIndicator = cartCount.closest('.nav-item');
      if (cartIndicator) {
        cartIndicator.style.display = data.cart_count > 0 ? 'block' : 'none';
      }
    }
    
    // Remplacer le contenu du panier avec le HTML reçu
    const cartSection = document.getElementById('cart-section');
    if (cartSection && data.cart_html) {
      cartSection.outerHTML = data.cart_html;
    }
    
    // Animation du panier pour feedback visuel
    const cartIcon = document.querySelector('.fa-shopping-cart');
    if (cartIcon) {
      cartIcon.style.transform = 'scale(1.2)';
      cartIcon.style.transition = 'transform 0.2s ease';
      setTimeout(() => {
        cartIcon.style.transform = 'scale(1)';
      }, 200);
    }
    
    // Scroll automatique vers le panier après ajout
    setTimeout(() => {
      const newCartSection = document.getElementById('cart-section');
      if (newCartSection) {
        newCartSection.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }
    }, 300);
  }
  
  function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
      position: fixed; 
      top: 20px; 
      right: 20px; 
      z-index: 1050;
      min-width: 300px; 
      padding: 15px;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    
    document.body.appendChild(messageDiv);
    setTimeout(() => messageDiv.remove(), 3000);
  }
});

// Fonctions globales pour les boutons du panier
function removeFromCart(platId) {
  if (!confirm('Êtes-vous sûr de vouloir retirer ce plat du panier ?')) {
    return;
  }
  
  fetch(`/commandes/remove_from_cart`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Accept': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ plat_id: platId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateCartDisplay(data);
      showMessage(data.message || 'Plat retiré du panier', 'success');
    } else {
      showMessage(data.message || 'Erreur lors de la suppression', 'error');
    }
  })
  .catch(error => {
    showMessage('Erreur lors de la suppression', 'error');
  });
}

function updateCartDisplay(data) {
  // Mettre à jour le compteur dans la navbar
  const cartCount = document.querySelector('.cart-count');
  if (cartCount) {
    cartCount.textContent = data.cart_count;
    const cartIndicator = cartCount.closest('.nav-item');
    if (cartIndicator) {
      cartIndicator.style.display = data.cart_count > 0 ? 'block' : 'none';
    }
  }
  
  // Remplacer le contenu du panier avec le HTML reçu
  const cartSection = document.getElementById('cart-section');
  if (cartSection && data.cart_html) {
    cartSection.innerHTML = data.cart_html;
  }
  
  // Animation du panier pour feedback visuel
  const cartIcon = document.querySelector('.fa-shopping-cart');
  if (cartIcon) {
    cartIcon.style.transform = 'scale(1.2)';
    cartIcon.style.transition = 'transform 0.2s ease';
    setTimeout(() => {
      cartIcon.style.transform = 'scale(1)';
    }, 200);
  }
}
</script> 