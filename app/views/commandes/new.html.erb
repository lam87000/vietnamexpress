<div class="ordering-page">

<% unless @orders_enabled %>
    <div class="orders-disabled-banner">
      <p>⚠️ En raison d'une forte affluence, nous ne pouvons malheureusement pas prendre de nouvelles commandes pour le moment. Veuillez réessayer plus tard. Merci de votre compréhension. L'équipe du Vietnam Express Limoges</p>
    </div>
  <% end %>

  <!-- fin de l'affichage du message si les commandes sont fermées -->

  <h1>Passer une commande</h1>
  
  <% if flash[:alert] %>
    <div class="alert alert-danger">
      <%= flash[:alert] %>
    </div>
  <% end %>
  
  <!-- Menu des plats -->
  <div class="menu-section">
    <% @categories.each do |category| %>
      <div class="category-section">
        <h2><%= category.name %></h2>
        <% if category.description.present? %>
          <p class="category-description"><%= category.description %></p>
        <% end %>
        <div class="plats-grid">
          <% category.plats.available.each do |plat| %>
            <div class="plat-card" data-plat-id="<%= plat.id %>">
              <% if plat.has_image? %>
                <% if plat.is_local_image? %>
                  <%= image_tag plat.image_url, alt: plat.nom, class: "plat-image", loading: 'lazy' %>
                <% elsif plat.is_cloudinary_image? %>
                  <%= image_tag plat.image_url, alt: plat.nom, class: "plat-image", loading: 'lazy' %>
                <% else %>
                  <img src="<%= plat.image_url %>" alt="<%= plat.nom %>" class="plat-image" loading="lazy">
                <% end %>
              <% end %>
              <div class="plat-info">
                <h3><%= plat.nom %></h3>
                <p class="plat-description"><%= plat.description %></p>
                <p class="price"><%= plat.formatted_price %></p>
                <p class="stock">Stock disponible: <%= plat.stock_quantity %></p>
                
                <%= form_with url: add_to_cart_commandes_path, method: :post, local: false, class: "add-to-cart-form" do |f| %>
                  <%= f.hidden_field :plat_id, value: plat.id %>
                  <div class="quantity-controls">
                    <%= f.number_field :quantity, value: 1, min: 1, max: plat.stock_quantity, class: "quantity-input", disabled: !restaurant_accepting_orders? %>
                    <%= f.submit "Ajouter au panier", class: "btn btn-primary", disabled: !plat.available? || !restaurant_accepting_orders? %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Panier -->
  <div class="cart-section" id="cart-section">
    <%= render 'cart_items' %>
  </div>
</div>

<%= content_for :stylesheets do %>
  <%= stylesheet_link_tag "orders", "data-turbo-track": "reload" %>
<% end %>

<%= javascript_include_tag "cart" %>

<% if @selected_plat_id %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Attendre que la page soit complètement chargée
      setTimeout(function() {
        const platElement = document.querySelector('[data-plat-id="<%= @selected_plat_id %>"]');
        if (platElement) {
          // Scroll vers le plat avec une animation fluide
          platElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
          
          // Ajouter un effet visuel temporaire
          platElement.style.transition = 'all 0.3s ease';
          platElement.style.transform = 'scale(1.02)';
          platElement.style.boxShadow = '0 8px 25px rgba(200, 16, 46, 0.3)';
          
          setTimeout(function() {
            platElement.style.transform = 'scale(1)';
            platElement.style.boxShadow = '';
          }, 2000);
        }
      }, 500);
    });
  </script>
<% end %>